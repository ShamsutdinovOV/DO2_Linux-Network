## Part 1. Инструмент ipcalc
 - Установим инструмент ip calc командой sudo apt install ipcalc
#### 1.1. Сети и маски
 - Командой ipcalc -b 192.167.38.54/13 (флаг убирает двоичные значения)

![вывод утилиты icalc](png/part1(1).png)

- cмотрим вывод ip calc 255.255.255.0, где видим префикс 24, и 11111111.11111111.11111111. 00000000 в двоичной записи

![вывод утилиты icalc](png/part1(2).png)  

- cмотрим вывод ip calc /15, где видим измененный адрес 255.254.0.0, и 11111111.11111110.00000000. 00000000 в двоичной записи

![вывод утилиты icalc](png/part1(3).png) 

- cмотрим вывод ipcalc 11111111.11111111.11111111.11110000, где видим адрес 192.168.1.1, и префикс 24.

![вывод утилиты icalc](png/part1(4).png) 

- Cмотрим вывод ipcalc 12.167.38.4/8 и видим HOSTMAX 12.255.255.254 и HOSTMIN 12.0.0.1
  
![вывод утилиты icalc](png/part1(5).png) 

- Необходимо узнать HOSTMAX и HOSTMIN для 11111111.11111111.00000000.00000000. Т.к. каждый блок до точки идентичен маске /8 (по количеству единиц), то вводим команду ipcalc /16. Имеем в результате HOSTMAX 12.167.255.254 и HOSTMIN 12.167.0.1

![вывод утилиты icalc](png/part1(6).png) 

- Далее нужен вывод для 255.255.254.0. 255 - идентично /8 и 11111111. Соответственно, вводим команду ipcalc /23 и получаем HOSTMAX 12.167.39.254 и HOSTMIN 12.167.38.1

![вывод утилиты icalc](png/part1(7).png) 

- В завершении узнаем данные из вывода маски /4. HOSTMAX 15.255.255.254 и HOSTMIN 0.0.0.1

![вывод утилиты icalc](png/part1(7).png) 

#### 1.2. localhost

 - Диапазон адресов для локального хоста не превышает 192.168.255.255, поэтому 194.34.23.100 не является локальным

![вывод утилиты icalc](png/part1(8).png) 

- К адресам 127.0.0.2 и 127.1.0.1 можно обратиться, т.к. в строчке Hosts/Net имеется информация LOOPBACK

![вывод утилиты icalc](png/part1(9).png) 
![вывод утилиты icalc](png/part1(10).png) 

- В отличии от адреса 128.0.0.1, которые такой отметки в выводе не имеет.
  
![вывод утилиты icalc](png/part1(11).png)  

#### 1.3. Диапазоны и сегменты сетей
- Адреса, которые начинают на 10, 127, 169. Соответственно адрес 10.0.0.45 - частный, а 134.43.0.2 - публичный. Адреса, которые начинают на 192 и 172 могут быть и теми, и теми. проверим их командой ipcalc. В выводе обратим внимание на последнюю строчку, где ждем private internet, что указывает на частный характер адреса. 
![вывод утилиты icalc](png/part1(11).png) 
![вывод утилиты icalc](png/part1(12).png) 
![вывод утилиты icalc](png/part1(13).png) 
![вывод утилиты icalc](png/part1(14).png) 
![вывод утилиты icalc](png/part1(15).png) 
![вывод утилиты icalc](png/part1(16).png) 
![вывод утилиты icalc](png/part1(17).png) 
![вывод утилиты icalc](png/part1(18).png) 
![вывод утилиты icalc](png/part1(19).png)

- Чтобы узнать подходит ли ip-адрес шлюза данной сети, проверим вхождение адреса в максимальный и минимальный диапазон командой ip calc 10.10.0.0/18 -b, где увидим что в промежутке между HostMin и HostMax находятся два адреса из перечисленных - 10.10.0.2 и 0.10.10.10
  
![вывод утилиты icalc](png/part1(20).png)

## Part 2. Статическая маршрутизация между двумя машинами

- вводим ip a и смотрим вывод:
![вывод ip a](png/part2(1).png)

- Заходим в файл /etc/netplan/00-installer-config.yaml
  Прописываем ip-адрес/префикс для ws1

  ![описываем внутренню сеть ws1](png/part2(2).png)

- командами netplan apply и netplan try перезапускаем и подтверждаем изменения. Проверяем изменения:

![вывод ip a](png/part2(3).png)

- Повторяем вышеописанные действия для второй машины ws2
  
![вывод ip a для ws2](png/part2(4).png)
![описываем внутренню сеть ws1](png/part2(5).png)
![вывод ip a](png/part2(6).png)

#### 2.1. Добавление статического маршрута вручную
- Находясь в машине ws1:
  - Командой sudo ip r add 172.24.116.8 dev enp0s3 добавляю маршрут,проверим соединения ip r и сразу пингую:
  ![пинг соединения ws1->ws2](png/part2(7).png)

- Находясь в машине ws2 повторяем те же действия:
  ![пинг соединения ws2->ws1](png/part2(8).png)

#### 2.2. Добавление статического маршрута с сохранением
- В файл 00-installer-config.yaml добавляем данные routes для обеих машин:

- ws1
 ![routes на ws1](png/part2(9).png)

- ws2
 ![routes на ws2](png/part2(10).png)

- Пингуем соединение на обеих машинах.

- ws1
 ![пинг на ws1](png/part2(11).png)

- ws2
 ![пинг на ws2](png/part2(12).png)

## Part 3. Утилита iperf3
#### 3.1. Скорость соединения
- 8 Mbps =  1 MB/s
- 100 MB/s = 800000 Kbps
- 1 Gbps = 1000 Mbps

#### 3.2. Утилита iperf3
- Чтобы установить iperf3 необходимо получить доступ к внешней сети (сейчас у обеих машин включена только внутрення сеть). Включаем в настройках VirtualBox на обеих машинах -> Сеть -> еще один адаптер с выбором сети NAT
- Включаем машины и на каждой машине добавляем описание внешнего сетевого интерфейса enp0s8:
![меняем netplan](png/part3(1).png)
- Устанавливаем программу iperf3 sudo apt install iperf3
  Запускаем на стороне сервера на ws1:
 ![сервер на ws1](png/part3(2).png) 
  Запускаем клиента:
 ![клиент на ws2](png/part3(3).png)

## Part 4. Сетевой экран
#### 4.1. Утилита iptables
- Создаем файл sudo nano /etc/firewall.sh на обеих машинах. Удаляем согласно заданию все правила. Прописываем новые правила:
     - Флагом -A добавляем правило. Определяем тип цепочки как входящий параметром INPUT. Далее флагом -p указываем тип протокола вручную - tcp и флагом -d указываем адрес получателя (порты 22 и 80). Теперь -j ACCEPT тем самым, разрешая доступ к портам.
     - Далее сперва запрещаем пинг DROP (тип цепочки теперь OUTPUT т.к. мы теперь ждем ответа на пинг), указывая на тип протокола icmp(служба обмена служебными сообщениям) и на тип команды 0(echo-reply).
![firewall на ws1](png/part3(4).png)    
![firewall на ws2](png/part3(5).png)  

Запускаем файл:
- на ws1

![запуск файервола1](png/part3(6).png)

- на ws2

![запуск файервола1](png/part3(7).png)

Разница в стратегиях заключается в том, что в первом случае мы изначально запретили пинг, а затем разрешили, а во втором случае наоборот.

#### 4.2. Утилита nmap
- Пингуем на ws1 машину ws2 и проверяем доступность хоста ws2
  
![nmap на ws1](png/part3(8).png)

## Part 5. Статическая маршрутизация сети

- Создали/скопировали еще 3 виртуальные машины.
- Создали еще две внутренние сети в Virtual Box, у каждой машины пробросили порты.
- Для создания маршрутов в каждой из машин описали сетевые интерфейсы в 00-installer-config.yaml
  
  - ws11
  ![netplan на ws11](png/part3(9).png)

  - ws21
  ![netplan на ws21](png/part3(10).png)

  - ws22

  ![netplan на ws22](png/part3(11).png)

  - r1

  ![netplan на r1](png/part3(12).png)
 
  - r2

  ![netplan на r2](png/part3(13).png)

- Перезапускаем сеть командой sudo systemctl restart systemd-networkd
- Проверяем ip -4 a:
  - r1 

![адрес r1](png/part3(17).png)

- Проверяем ip -4 a:
  - r2 

![адрес r1](png/part3(16).png)

- Пингуем с w22 - ws21
- 
![пинг r1](png/part3(14).png)

- Пингуем с w11 - r1
- 
![пинг r1](png/part3(15).png)

#### 5.2. Включение переадресации IP-адресов

Вводим команду sysctl -w net.ipv4.ip_forward=1 на:

   - r1
  
  ![переадресация r1](png/part5(1).png)

  - r2
  
  ![переадресация r2](png/part5(2).png)

  Добавляем строчку в /etc/syscl.conf:
  - в r1

  ![conf 1](png/part5(3).png)

  - в r2

  ![conf 2](png/part5(4).png)

  #### 5.3. Установка маршрута по умолчанию

- Изменяем файл конфигурации у всех машин заменив подключаемый ip адрес на default.

  - r1

![шлюз r1](png/part5(5).png)
  
  - r2

![шлюз r2](png/part5(6).png)

  - ws11

![шлюз ws11](png/part5(7).png)

  - ws21

![шлюз ws21](png/part5(8).png)

  - ws22

![шлюз ws22](png/part5(9).png)

- Проверяем через ip r 
  
![шлюз ws22](png/part5(10).png)![шлюз ws22](png/part5(11).png)
![шлюз ws22](png/part5(12).png)![шлюз ws22](png/part5(13).png)    
![шлюз ws22](png/part5(14).png)

- Пингуем с ws11 - r2
  
![пинг ws11](png/part5(15).png)

- На r2 проверяем пинг

![прием пинга на r2](png/part5(16).png)

#### 5.4. Добавление статических маршрутов

Для добавления статических маршрутов изменим в routes направление маршрута на обоих роутерах:

- r1

![config r1](png/part5(17).png)

- r2

![config r2](png/part5(18).png)

- Показываем вывод ip r для обоих роутеров:

- r1

![ip r r1](png/part5(19).png)

- r2

![ip r r2](png/part5(20).png)

- На станции ws11 отобразим текущую таблицу маршрутизации:
  для 10.10.0.0/18 и для 0.0.0.0/0

![ip r list ws11](png/part5(21).png)

Т.к. 10.10.0.0/18  является более специфичным маршрутом, система выбирает именно его согласно приоритетности, это позволяет системе более эффективно управлять маршрутом.

#### 5.5. Построение списка маршрутизаторов
- На первом роутере запускаем команду tcpdump -tnv -i enp0s8
- 
![dump на r1](png/part5(22).png)

- С машины ws11 запускаем утилиту traceroute c флагом i (для использование ICMP) до хоста 10.20.0.10 (ws21)

![traceroute до ws21](png/part5(23).png)

- Маршрут строиться по шлюзам до конечной точки. На каждом шлюзе добавляется счетчик, который отслеживает количество пройденых узлов.

#### 5.6. Использование протокола ICMP при маршрутизации

- Запускаем перехват сетевого трафика tcpdump -n -i enp0s8 icmp:

![перехват трафика на r1](png/part5(24).png)

- Пингуем с ws11 несуществующий ip-адрес:

![пинг с ws11](png/part5(25).png)

## Part 6. Динамическая настройка IP с помощью DHCP

- На r2 настраиваем в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:

![конфигурация службы DHCP на r2](png/part5(26).png)

- В файле /etc/resolv.conf меняем nameserver

![замена nameserver на r2](png/part5(27).png)

- Перезагружаем сервер и ребутнем машину ws21. После ребута присвоим новый адрес из пула доступных с помощью dhclient и проверим ip a:

![ip a на ws21](png/part5(28).png)

- Пингуем с ws21 на ws22:

![ping ws21](png/part5(29).png)

- Аналогичные действия проводим с первым роутером. Но, сперва нужно изменить MAC-адрес ws11 (в настройках VB тоже):

![мак адрес ws11 на вб](png/part6(1).png)

- и файле конфигурации + dhcp4: yes:

![мак адрес ws11 на вб](png/part6(2).png)

- Правим файл конфигурации на r1 (добавляем фиксированный адрес) и меняем nameserver в resolv.conf:

![conf на r1](png/part6(3).png)
![nameserv на r1](png/part6(4).png)

- Рестарт службы DHCP на r1 и ребут на ws11. Проверяем присвоение нового адреса и пингуем на ws22:

![ip a на ws11](png/part6(5).png)
![ping на ws22](png/part6(6).png)

- Запросим обновление ip-адреса на ws21. Для это опцией -r  удалим действующий адрес
![ip a на ws11](png/part6(7).png)

- Затем флагом -v вновь присвоим адрес:
- 
![ping на ws22](png/part6(8).png)

## Part 7. NAT.

- Устанавливаем пакет apache2 <sudo install apt apache2>
  После установки меняем файл конфигурации на ws22 и r1 sudo nano /etc/apache2/ports.conf, поменяв строку LISTEN, сделав сервер общедоступным. 

![listen на r1](png/part7(1).png)
![listen на ws22](png/part7(2).png)

- Командой service restart apache2 запускем сервис на обеих машинах:

![start на r1](png/part7(3).png)
![start на ws22](png/part7(4).png)

- Cоздаем фаерволл с правилами /etc/firewall.sh на r2:

![фаерволл на r2](png/part7(5).png)

- Правила прописанные в файле "дропают" все пакеты, проходящие через маршрутизатор. Запускаем файл и пингуем:

![запуск на r2](png/part7(6).png)
![вывод на r2](png/part7(7).png)
![пинг на r1](png/part7(8).png)

- Добавляем в firewall новое правило, разрешающие все пакеты icmp, проходящие через маршрутизатор. Флагом -A мы добавляем правило, указываем цепочку FORWARD (проходящий), указывает тип протокола и действие:

![firewall на r2](png/part7(9).png)

- Пингуем с ws22 на r1:

![пинг на r1](png/part7(10).png)

- Добавляем еще 2 правила:
  1) Включи SNAT, а именно маскирование всех локальных IPиз локальной сети, находящейся за r2 (по обозначениям из Части 5 — сеть 10.20.0.0).
  - Сперва разрешаем проходы через исходящий и порт назначения 80 и через роутер.
  - Далее маскируем исходящий адрес
  -  Разрешаем проход уже установленных соединений
  1) Включаем DNAT на 8080 порт машины r2 и добавляем к Apache, запущенному на ws22, доступ извне сети.
![firewall на r2](png/part7(11).png)  

- Проверяем через telnet наши соединения c ws22 до r1 и обратно:

- SNAT
![SNAT](png/part7(12).png)

- DNAT 
- 
![DNAT](png/part7(13).png)

## Part 8. Дополнительно. Знакомство с SSH Tunnels

- Открываем файл конфигурации на r2 командой sudo nano /etc/firewall.sh

![firewall на r2](png/part8(1).png) 

- Меняем порт в файле sudo nano /etc/apache/ports.conf на ws22
   listen 0:0:0:0:80 на listen localhost:80

![apache на ws22](png/part8(2).png) 

- Используем Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21. Для этого вводим ssh -L 8080:localhost:80 guetta@10.20.0.20   

- Вводим команду:
![ssh](png/part8(3).png) 

- И получили вход на ws22 из ws21:
![ssh](png/part8(4).png)

- Проверяем работало ли подключение командой telnet 127.0.0.1 80
![телнет на ws22](png/part8(5).png)

- Далее воспользуйемся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11. Для этого с машины ws22 запускаем ssh -R 8080:localhost:80 10.10.0.2

![ws22 на ws11](png/part8(6).png)
![ws22 на ws11](png/part8(7).png)

- Проверяем telnet 127.0.0.1 80 на втором терминале

![телнет на ws22](png/part8(8).png)